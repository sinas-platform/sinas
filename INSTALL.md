# SINAS Installation Guide

## Quick Install (Recommended)

Run the automated installer on a fresh Ubuntu 22.04+ VPS:

```bash
# Clone repository
git clone <your-sinas-repo>
cd SINAS

# Run installer
sudo bash install.sh
```

The script will:
- ✅ Install Docker & Docker Compose
- ✅ Generate secure keys automatically
- ✅ Prompt for configuration (domain, SMTP, etc.)
- ✅ Create `.env` file
- ✅ Start all services
- ✅ Auto-provision SSL certificates

**That's it!** SINAS will be running at:
- Backend API: `https://your-domain.com` (via Caddy with auto SSL)
- Console UI: `https://your-domain.com:51245` (via Caddy with auto SSL)

---

## Manual Installation

If you prefer to configure manually:

### 1. Prerequisites

```bash
# Install Docker
curl -fsSL https://get.docker.com | sh

# Install Docker Compose
apt install docker-compose-plugin
```

### 2. Configure

```bash
# Copy example environment
cp .env.example .env

# Edit configuration
nano .env
```

**Required variables:**
```bash
SECRET_KEY=<openssl rand -hex 32>
ENCRYPTION_KEY=<python3 -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())">
DATABASE_PASSWORD=<secure-password>
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASSWORD=<your-api-key>
SMTP_DOMAIN=yourdomain.com
DOMAIN=yourdomain.com
SUPERADMIN_EMAIL=admin@yourdomain.com
```

### 3. DNS Setup

Point your domain to the server:
```
A Record: yourdomain.com → YOUR_SERVER_IP
```

**Open firewall ports:**
- 80 (HTTP → HTTPS redirect)
- 443 (Backend API HTTPS)
- 51245 (Console UI HTTPS)
- 22 (SSH)

### 4. Start Services

```bash
# Build and start all services
docker-compose build
docker-compose up -d
```

### 5. Verify

```bash
# Check backend health
curl https://yourdomain.com/health
# Should return: {"status":"healthy"}

# Access console
# https://yourdomain.com:51245
```

---

## What Gets Installed

The Docker Compose stack includes:

- **sinas-backend** - FastAPI application (internal port 8000)
- **sinas-console** - React UI served by Nginx (internal port 80)
- **postgres** - PostgreSQL database
- **clickhouse** - Analytics database (optional)
- **caddy** - Reverse proxy with automatic HTTPS

---

## Post-Installation

### Access Console UI
```
http://your-domain.com:51245
```

Note: Console is HTTP on port 51245. For HTTPS, configure nginx inside the console container or use a separate reverse proxy.

### Login as Superadmin
1. Go to console UI
2. Enter your superadmin email
3. Check email for OTP code
4. Enter OTP to log in

### View Logs
```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f backend
docker-compose logs -f console
```

### Update SINAS
```bash
git pull
docker-compose build
docker-compose up -d
```

### Backup Database
```bash
docker exec sinas-postgres pg_dump -U postgres sinas > backup.sql
```

---

## Local Development

For local development (no HTTPS):

```bash
# Don't set DOMAIN in .env (or set DOMAIN=localhost)
docker-compose up -d

# Backend: http://localhost:8000
# Console: http://localhost:51245
```

Caddy is automatically disabled for local dev - services expose ports directly.

---

## Troubleshooting

### SSL Not Working?
- Check DNS: `dig yourdomain.com`
- View Caddy logs: `docker-compose logs caddy`
- Wait 1-2 minutes for certificate provisioning
- Ensure ports 80, 443, 51245 are open in firewall

### Services Not Starting?
```bash
docker-compose ps        # Check status
docker-compose logs      # View errors
```

### Database Connection Issues?
- Verify `DATABASE_PASSWORD` in `.env`
- Check if postgres is running: `docker-compose ps postgres`

### Email (OTP) Not Sending?
- Verify SMTP credentials in `.env`
- Check app logs: `docker-compose logs backend | grep SMTP`

### Console Not Loading?
- Check nginx logs: `docker-compose logs console`
- Verify port 51245 is open
- Try clearing browser cache

---

## Minimum Requirements

- **OS:** Ubuntu 22.04+ (or any Linux with Docker support)
- **RAM:** 2GB minimum, 4GB recommended
- **CPU:** 2 cores minimum
- **Storage:** 50GB minimum
- **Ports:** 80, 443, 51245, 22 (SSH)

---

## Security Recommendations

1. **Use strong passwords** - Auto-generated by install script
2. **Configure firewall** - Use UFW or cloud provider firewall
3. **Keep updated** - Run `git pull && docker-compose up -d --build` regularly
4. **Backup regularly** - Set up automated database backups
5. **Use SSH keys** - Disable password authentication for SSH
6. **SSL/TLS** - Caddy handles this automatically via Let's Encrypt

---

## Architecture Overview

See [MONOREPO.md](MONOREPO.md) for detailed architecture and development workflow.

SINAS is a monorepo with:
- **Backend** (`backend/`): Python/FastAPI
- **Console** (`console/`): React/TypeScript
- **Deployment**: Multi-container Docker setup with Nginx and Caddy
